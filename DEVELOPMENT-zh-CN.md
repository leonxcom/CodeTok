# Vibetok 开发指南

## 项目概述

Vibetok 是一个创新的 AI项目 和代码应用的分享平台。它基于 Next.js 构建，采用了 TypeScript 作为开发语言，并集成了多个 UI 组件库来提供丰富的用户界面体验。

## 技术栈

- **框架**:
  - Next.js 15 (App Router)
  - React 18.3.1
- **UI库**:
  - React 19 (Next.js)
  - React 18.3.1
- **开发语言**: TypeScript
- **样式**:
  - Tailwind CSS v4 (Next.js)
  - Tailwind CSS 3.4.4
- **组件库**:
  - Shadcn UI
  - Radix UI (Primitives)
- **构建工具**:
  - Vite 5.2.13
- **图标库**:
  - Lucide React 0.424.0
- **工具库**:
  - clsx - 用于构造类名字符串的工具
  - tailwind-merge - 合并Tailwind CSS类而不产生样式冲突
  - class-variance-authority - 类型安全的UI组件变体
- **包管理**: pnpm

### 后端与数据库

- **数据库**: Neon Database (Serverless PostgreSQL)
- **ORM**: Drizzle ORM
- **存储**: Vercel Blob Storage (用于文件上传和代码分享)
- **身份认证**: Better Auth
- **API**: Next.js API Routes + Next Safe Action
- **邮件服务**: Resend
- **支付处理**:
  - Stripe
  - Creem.io

### 国际化

- **i18n框架**: Next-intl

### 分析与AI

- **分析工具**:
  - Plausible Analytics
  - Google Analytics
- **AI集成**: Vercel AI SDK
- **内容管理**: Content Collections

### 数据展示

- **表格**: Tanstack Table

### 开发工具

- **AI IDE**: Trae
- **代码质量**:
  - ESLint
  - Prettier
  - TypeScript严格模式
- **Git工作流**:
  - 约定式提交
  - 分支开发
  - GitHub Actions CI/CD

## 目录结构

```
Vibetok/
├── app/                      # Next.js 15 App Router
│   ├── [locale]/            # 国际化路由
│   ├── api/                 # API路由
│   └── providers.tsx        # 全局提供者
├── components/              # React组件
│   ├── ui/                 # Shadcn UI组件
│   └── features/           # 功能组件
├── db/                      # 数据库Schema和客户端
│   ├── schema.ts           # Drizzle Schema
│   └── index.ts            # DB客户端
├── config/                  # 配置文件
├── i18n/                    # 国际化
│   ├── client.ts           # 客户端国际化
│   └── server.ts           # 服务端国际化
├── lib/                     # 工具函数
│   ├── auth.ts             # 认证逻辑
│   ├── actions.ts          # 服务器操作
│   └── stripe.ts           # 支付逻辑
├── messages/               # 翻译文件
├── public/                 # 静态资源
└── styles/                 # 全局样式
```

## 组件库

### Shadcn UI

Shadcn UI 是一套基于 Radix UI 和 Tailwind CSS 构建的无样式组件集合，提供了高度可定制的组件，用于构建现代化的用户界面。

组件位于 `src/components/ui` 目录，通过 `@/components/ui` 导入路径导出。

主要组件包括：

- Button, Input, Form 等基础组件
- Dialog, Sheet, Popover 等交互组件
- Table, DataTable 等数据展示组件

## 开发规范

### 核心原则

**始终遵循官方文档**: 在集成库、框架或API时，必须严格按照其官方文档作为首要参考标准进行开发。这确保了兼容性、正确的实现方式，并利用了技术创建者推荐的最佳实践。官方文档的优先级高于其他参考资料或之前的实现模式。

### 代码风格

- 使用 TypeScript 进行类型检查
- 遵循 ESLint 和 Prettier 配置的代码格式
- 模块化开发，每个功能模块应该有自己的目录

### 组件开发原则

1. **模块化**: 每个功能模块开发归档两份 README，一份英文文档，一份简体中文，总结功能、接口和使用方式
2. **小步快跑**: 每次只开发一个功能，代码遵循最佳实践，不搞黑科技
3. **及时提交**: 每完成一个节点提交一下 git 暂存
4. **完整测试**: 每个模块开发完成后，必须进行全面测试，包括组件测试、API测试、集成测试和跨浏览器测试，确保功能正常工作无误，所有测试通过后才能视为模块完成

### 命名规范

- 组件文件名: PascalCase (例如 `Button.tsx`)
- 工具函数文件名: camelCase (例如 `useMediaQuery.ts`)
- CSS 类名: kebab-case 或遵循 Tailwind CSS 约定

### 注释规范

- 组件文件顶部应有组件功能说明
- 复杂逻辑应有相应注释
- 公共 API 和接口应有完整文档注释
- 代码注释使用英文

### 国际化

- 界面文本使用国际化方案，不硬编码
- 支持中英文切换
- 国际化文件位于 `messages` 目录

### 包管理

- 统一使用 pnpm 进行包管理
- 添加新依赖时确保依赖版本锁定

### Git 提交规范

- 提交信息使用英文
- 提交信息格式: `<type>: <description>`
- 类型包括: feat(新功能), fix(修复), docs(文档), style(格式), refactor(重构), test(测试), chore(杂项)

## 本地开发

### 环境设置

1. 克隆仓库
2. 安装依赖: `pnpm install`
3. 运行开发服务器: `pnpm dev`

### 安装新组件

#### Shadcn UI 组件

```bash
pnpm dlx shadcn@latest add <component-name>
```

## 构建与部署

### 构建

```bash
pnpm build
```

### 预览构建

```bash
pnpm start
```

## 问题解决

### 常见问题

如遇到与组件导入相关的问题，可能是导入路径问题。组件应该从 `@/components/ui` 导入。

如需修复导入路径，可参考之前使用的脚本修复方法。

## UI设计规范

### 核心交互元素

平台具有几个关键的交互元素，旨在提升用户参与度：

#### 骰子随机导航按钮

平台的核心交互元素是一个骰子按钮(🎲)，取代传统的红色按钮：
- **功能**：点击时导航用户至随机代码片段
- **设计**：使用骰子emoji(🎲)直观地表示随机性
- **悬停效果**：仅当鼠标悬停在骰子上时显示"随机前往下一个项目"文字
- **位置**：位于界面底部中央或页面的显著区域
- **可访问性**：必须在桌面和移动设备上都易于点击

#### 框架控制

- **Remove Frame**：允许用户在没有周围UI元素的情况下查看内容
  - 移除导航和非必要UI组件，提供专注的阅读体验
  - 必须提供明显的方式恢复框架
- **Home**：快速导航回平台首页

### 布局结构

界面遵循基于容器的设计方法：

```
+-------------------------------------------------------+
|  品牌                                      [控制区]  |
|-------------------------------------------------------|
|                                                       |
|  +---------------------------------------------------+  |
|  |                  代码展示区域                     |  |
|  +---------------------------------------------------+  |
|                                                       |
|  +---------------------------------------------------+  |
|  |                评论/互动区域                      |  |
|  +---------------------------------------------------+  |
|                                                       |
|  [导航区]              [红色按钮]         [框架控制]   |
+-------------------------------------------------------+
```

### 垂直互动按钮

互动按钮垂直排列在代码显示区域的右侧：

```
+---------------------------------------------------+ +-----+
| [语言] [复制] [全屏]                              | |     |
|---------------------------------------------------| | [点赞]|
|                                                   | |     |
|                代码内容                           | |-----|
|                                                   | | [评论]|
|                                                   | |     |
+---------------------------------------------------+ |-----|
                                                      | [收藏]|
                                                      |     |
                                                      |-----|
                                                      | [分享]|
                                                      |     |
                                                      +-----+
```

#### 按钮功能

- **点赞**：允许用户对代码片段表示赞赏
- **评论**：打开/关闭评论区域
- **收藏**：将代码片段添加到用户的收藏集
- **分享**：生成代码片段的可分享链接

### 容器设计

每个代码片段都包含在一个自包含的模块中，具有以下结构：
- 标题部分
- 标签部分
- 具有语法高亮的代码显示区域
- 互动区域

这种基于容器的方法确保：
- 相关内容的适当封装
- 平台整体一致性
- 针对不同屏幕尺寸的响应式行为
- 支持浅色和深色主题

### 技术实现考虑

1. **按钮实现**：使用Shadcn UI组件
2. **语法高亮**：集成支持所有主要编程语言的库
3. **动画效果**：为按钮交互和状态变化实现微妙的动画
4. **主题集成**：所有UI元素必须尊重用户选择的主题
5. **骰子按钮**：使用标准emoji(🎲)配合悬停文字说明，而非自定义图形
6. **框架控制**：使用CSS类和状态管理来切换UI元素

### 可访问性要求

1. **键盘导航**：所有交互元素必须可通过键盘访问
2. **屏幕阅读器支持**：为所有交互元素提供适当的ARIA标签
3. **色彩对比度**：所有文本和交互元素保持WCAG 2.1 AA合规
4. **响应式设计**：UI必须能够平滑适应所有设备尺寸和方向

该设计系统优先考虑简洁性、参与度和可访问性，同时保持专业、以代码为中心的用户体验。

## 无需登录的代码分享功能

平台现已支持无需用户登录的代码分享功能，参考了类似 yourware.so 的服务实现。

### 功能概述

- **上传方式：**
  - 直接在文本区域粘贴代码
  - 文件上传（HTML、TSX、CSS、JS）
  - 文件夹上传（包含HTML、CSS、JS文件）
  
- **技术实现：**
  - 使用UUID生成唯一项目ID
  - 文件存储在Vercel Blob Storage，使用`@vercel/blob`
  - 项目元数据存储在Neon PostgreSQL
  - 文件大小限制：10MB
  - 支持TSX文件执行，使用浏览器端Babel编译

### 存储实现

```typescript
// 使用Vercel Blob存储项目
import { put } from '@vercel/blob';

// 上传文件到Vercel Blob
const uploadFile = async (file, projectId) => {
  const { url } = await put(`projects/${projectId}/${file.name}`, file, {
    access: 'public',
  });
  return url;
};

// 将元数据存储到PostgreSQL
const storeProject = async (projectId, files) => {
  await db.insert(projects).values({
    id: projectId,
    files: JSON.stringify(files),
    createdAt: new Date()
  });
};
```

### API接口

```
POST /api/projects         # 创建新项目，上传文件/代码
GET  /api/projects/random  # 获取随机项目
GET  /api/projects/:id     # 获取特定项目数据
```

### 界面组件

1. **上传页面** (`/[locale]/upload`)
   - 分为粘贴区域和拖放区域的界面
   - 处理文本输入和文件上传
   - 通过API创建项目

2. **项目查看** (`/[locale]/project/[id]`)
   - 在查看器中显示上传的代码
   - 支持在代码视图和预览之间切换
   - 包含"移除边框"等功能，实现无干扰查看
   - 侧边栏文件浏览器用于多文件项目

3. **首页随机项目**
   - 骰子按钮(🎲)用于探索随机项目
   - 精选随机项目的预览面板

### 安全考虑

- 文件类型验证，防止恶意上传
- 内容净化，防止XSS攻击
- iframe代码预览的沙箱隔离
